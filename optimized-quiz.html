<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸŒ ã‚¯ã‚¤ã‚ºãƒ»ã‚ªã‚¿ã‚¯çŸ¥è­˜ã®æ³‰ - æœ€é©åŒ–ç‰ˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            color: white;
        }

        .container {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 40px;
            max-width: 700px;
            width: 100%;
            text-align: center;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .title {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .subtitle {
            font-size: 1.2em;
            margin-bottom: 30px;
            opacity: 0.9;
        }

        .stats {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .optimization-info {
            background: rgba(0, 255, 0, 0.1);
            border: 2px solid rgba(0, 255, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
            font-size: 0.9em;
        }

        .data-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #FFD700;
        }

        .button-group {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .button {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 10px;
            padding: 15px 25px;
            color: white;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
        }

        .button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .random-button {
            background: rgba(255, 215, 0, 0.3);
            border: 2px solid rgba(255, 215, 0, 0.5);
        }

        .difficulty-section {
            margin: 20px 0;
        }

        .difficulty-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .difficulty-button {
            background: rgba(255, 255, 255, 0.15);
            border: 2px solid transparent;
            border-radius: 8px;
            padding: 12px;
            color: white;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .difficulty-button:hover {
            border-color: rgba(255, 215, 0, 0.5);
        }

        .difficulty-button.selected {
            border-color: rgba(255, 215, 0, 0.8);
            background: rgba(255, 215, 0, 0.2);
        }

        .loading {
            background: rgba(255, 215, 0, 0.2);
            border: 2px solid rgba(255, 215, 0, 0.5);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .quiz-header {
            margin-bottom: 30px;
        }

        .progress {
            font-size: 1.1em;
            opacity: 0.8;
            margin-bottom: 10px;
        }

        .question-meta {
            font-size: 0.9em;
            opacity: 0.7;
            margin-bottom: 15px;
        }

        .question {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 30px;
        }

        .choices {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 30px;
        }

        .choice {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid transparent;
            border-radius: 10px;
            padding: 15px;
            color: white;
            font-size: 1em;
            cursor: pointer;
            text-align: left;
            transition: all 0.3s ease;
        }

        .choice:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .choice.selected {
            border: 2px solid rgba(255, 215, 0, 0.8);
            background: rgba(255, 215, 0, 0.2);
        }

        .back-button {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            padding: 10px 20px;
            color: white;
            font-size: 0.9em;
            cursor: pointer;
            margin-top: 20px;
        }

        .result {
            margin-bottom: 30px;
        }

        .emblem {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5em;
            margin: 0 auto 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            font-size: 1.2em;
        }

        .hidden {
            display: none;
        }

        .disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        @media (max-width: 600px) {
            .container {
                padding: 20px;
            }
            
            .title {
                font-size: 2em;
            }

            .data-stats {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”»é¢ -->
        <div id="menu" class="screen">
            <h1 class="title">ğŸŒ ã‚¯ã‚¤ã‚ºãƒ»ã‚ªã‚¿ã‚¯çŸ¥è­˜ã®æ³‰</h1>
            <p class="subtitle">æœ€é©åŒ–ç‰ˆ - å¿…è¦ãªåˆ†ã ã‘èª­ã¿è¾¼ã¿</p>
            
            <div class="optimization-info">
                <h4>âš¡ æœ€é©åŒ–æ©Ÿèƒ½</h4>
                <ul style="text-align: left; margin-top: 10px;">
                    <li>ğŸ“Š é¸æŠã—ãŸã‚·ãƒªãƒ¼ã‚ºã®ã¿èª­ã¿è¾¼ã¿</li>
                    <li>ğŸ¯ æŒ‡å®šé›£æ˜“åº¦ã®å•é¡Œã®ã¿å–å¾—</li>
                    <li>ğŸ’¾ ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ã‚’å¤§å¹…å‰Šæ¸›</li>
                    <li>ğŸš€ é«˜é€ŸãªåˆæœŸè¡¨ç¤º</li>
                </ul>
            </div>

            <div class="stats">
                <h3>ğŸ“Š åˆ©ç”¨å¯èƒ½ãªãƒ‡ãƒ¼ã‚¿ï¼ˆã‚ªãƒ³ãƒ‡ãƒãƒ³ãƒ‰èª­ã¿è¾¼ã¿ï¼‰</h3>
                <div class="data-stats">
                    <div class="stat-card">
                        <div>ğŸ“º ãƒ¯ãƒ³ãƒ”ãƒ¼ã‚¹</div>
                        <div class="stat-number">300</div>
                        <div>å•</div>
                    </div>
                    <div class="stat-card">
                        <div>ğŸ“º ãƒ’ãƒ­ã‚¢ã‚«</div>
                        <div class="stat-number">298</div>
                        <div>å•</div>
                    </div>
                    <div class="stat-card">
                        <div>ğŸ“º HUNTERÃ—HUNTER</div>
                        <div class="stat-number">168</div>
                        <div>å•</div>
                    </div>
                </div>
                <p><strong>åˆè¨ˆ: 766å•ï¼ˆå¿…è¦ãªåˆ†ã ã‘èª­ã¿è¾¼ã¿ï¼‰</strong></p>
            </div>

            <div class="difficulty-section">
                <h4>ğŸ¯ é›£æ˜“åº¦ã‚’é¸æŠ</h4>
                <div class="difficulty-buttons">
                    <button class="difficulty-button selected" data-difficulty="all">
                        å…¨é›£æ˜“åº¦
                    </button>
                    <button class="difficulty-button" data-difficulty="1">
                        â­ åˆç´š
                    </button>
                    <button class="difficulty-button" data-difficulty="2">
                        â­â­ ä¸­ç´š
                    </button>
                    <button class="difficulty-button" data-difficulty="3">
                        â­â­â­ ä¸Šç´š
                    </button>
                    <button class="difficulty-button" data-difficulty="4">
                        â­â­â­â­ è¶…ã‚ªã‚¿ã‚¯ç´š
                    </button>
                </div>
            </div>

            <div class="button-group">
                <button class="button random-button" onclick="startQuiz('random')">
                    ğŸ² å…¨ã‚·ãƒªãƒ¼ã‚ºã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ å‡ºé¡Œï¼ˆ10å•ï¼‰
                </button>
                <button class="button" onclick="startQuiz('ãƒ¯ãƒ³ãƒ”ãƒ¼ã‚¹')">
                    ğŸ“º ãƒ¯ãƒ³ãƒ”ãƒ¼ã‚¹
                </button>
                <button class="button" onclick="startQuiz('åƒ•ã®ãƒ’ãƒ¼ãƒ­ãƒ¼ã‚¢ã‚«ãƒ‡ãƒŸã‚¢')">
                    ğŸ“º åƒ•ã®ãƒ’ãƒ¼ãƒ­ãƒ¼ã‚¢ã‚«ãƒ‡ãƒŸã‚¢  
                </button>
                <button class="button" onclick="startQuiz('HUNTERÃ—HUNTER')">
                    ğŸ“º HUNTERÃ—HUNTER
                </button>
            </div>
        </div>

        <!-- èª­ã¿è¾¼ã¿ç”»é¢ -->
        <div id="loading" class="screen hidden">
            <h2>ğŸ”„ å•é¡Œã‚’èª­ã¿è¾¼ã¿ä¸­...</h2>
            <div class="loading">
                <div id="loading-text">é¸æŠã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...</div>
                <div id="loading-details" style="margin-top: 10px; font-size: 0.9em;"></div>
            </div>
        </div>

        <!-- ã‚¯ã‚¤ã‚ºç”»é¢ -->
        <div id="quiz" class="screen hidden">
            <div class="quiz-header">
                <h2 id="quiz-title">ğŸ¯ ã‚¯ã‚¤ã‚º</h2>
                <div class="progress" id="progress">å•é¡Œ 1 / 10</div>
                <div class="question-meta" id="question-meta">é›£æ˜“åº¦: â­</div>
            </div>

            <div class="question">
                <h3 id="question-text">å•é¡Œæ–‡ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</h3>
            </div>

            <div class="choices" id="choices">
                <!-- é¸æŠè‚¢ãŒã“ã“ã«å‹•çš„ã«è¿½åŠ ã•ã‚Œã¾ã™ -->
            </div>

            <div class="button-group">
                <button class="button disabled" id="next-button" onclick="nextQuestion()">
                    æ¬¡ã®å•é¡Œ
                </button>
            </div>

            <button class="back-button" onclick="showMenu()">
                ğŸ  ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹
            </button>
        </div>

        <!-- çµæœç”»é¢ -->
        <div id="results" class="screen hidden">
            <h2>ğŸ‰ ã‚¯ã‚¤ã‚ºçµæœ</h2>
            
            <div class="result">
                <div class="emblem" id="emblem">ğŸ†</div>
                <h3 id="level-title">çµæœ</h3>
                <p id="level-description">èª¬æ˜</p>
            </div>

            <div class="stats">
                <div class="stat-item">
                    <span>æ­£è§£ç‡:</span>
                    <span id="accuracy">0%</span>
                </div>
                <div class="stat-item">
                    <span>æ­£è§£æ•°:</span>
                    <span id="score">0/0</span>
                </div>
                <div class="stat-item">
                    <span>å¹³å‡é›£æ˜“åº¦:</span>
                    <span id="avg-difficulty">â­</span>
                </div>
                <div class="stat-item">
                    <span>èª­ã¿è¾¼ã¿å•é¡Œæ•°:</span>
                    <span id="loaded-count">0å•</span>
                </div>
            </div>

            <div class="button-group">
                <button class="button" onclick="showMenu()">
                    ğŸ”„ ã‚‚ã†ä¸€åº¦æŒ‘æˆ¦
                </button>
            </div>
        </div>
    </div>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let currentQuestions = [];
        let currentQuestionIndex = 0;
        let answers = [];
        let selectedAnswer = null;
        let selectedDifficulty = 'all';
        let loadedQuestionCount = 0;

        // ã‚ªã‚¿ã‚¯åº¦åˆ¤å®šãƒ‡ãƒ¼ã‚¿
        const otakuLevels = [
            { threshold: 95, level: 'god', title: 'ç¥', description: 'å®Œç’§ã™ãã‚‹...ã‚‚ã¯ã‚„äººé–“ã‚’è¶…è¶Šã—ã¦ã„ã‚‹ã€‚ã‚¢ãƒ‹ãƒ¡ãƒ»æ¼«ç”»ç•Œã®ç¥ã¨ã—ã¦å´‡ã‚ã‚‰ã‚Œã‚‹ã¹ãå­˜åœ¨ã§ã™ã€‚', color: '#FFD700', emblem: 'ğŸ‘‘' },
            { threshold: 90, level: 'legend', title: 'ç”Ÿã‘ã‚‹ä¼èª¬', description: 'ã‚¢ãƒ‹ãƒ¡ãƒ»æ¼«ç”»ç•Œã®ç”Ÿãå­—å¼•ã€‚ãã®çŸ¥è­˜ã®æ·±ã•ã«å‘¨å›²ã¯ç•æ•¬ã®å¿µã‚’æŠ±ãã¾ã™ã€‚', color: '#FF6B35', emblem: 'âš¡' },
            { threshold: 80, level: 'veteran', title: 'å¤å‚å…µ', description: 'é•·å¹´åŸ¹ã£ãŸçŸ¥è­˜ãŒå…‰ã‚‹ã€ç«‹æ´¾ãªå¤å‚ã‚ªã‚¿ã‚¯ã€‚æ–°å‚è€…ã®æ†§ã‚Œã®å­˜åœ¨ã§ã™ã€‚', color: '#8A2BE2', emblem: 'ğŸ›¡ï¸' },
            { threshold: 70, level: 'otaku-egg', title: 'ã‚ªã‚¿ã‚¯ã®åµ', description: 'ã‚ªã‚¿ã‚¯ã®ç‰‡é±—ã‚’è¦‹ã›ã¦ã„ã¾ã™ã€‚ã•ã‚‰ãªã‚‹æˆé•·ã«æœŸå¾…ãŒé«˜ã¾ã‚Šã¾ã™ï¼', color: '#4169E1', emblem: 'ğŸ¥š' },
            { threshold: 60, level: 'general', title: 'ä¸€èˆ¬äºº', description: 'ä¸€èˆ¬çš„ãªçŸ¥è­˜ãƒ¬ãƒ™ãƒ«ã€‚ã‚¢ãƒ‹ãƒ¡ãƒ»æ¼«ç”»ã«èˆˆå‘³ã¯ã‚ã‚‹ã‚ˆã†ã§ã™ã­ã€‚ã¾ã ã¾ã ä¼¸ã³ã—ã‚ãŒã‚ã‚Šã¾ã™ï¼', color: '#32CD32', emblem: 'ğŸ‘¤' },
            { threshold: 40, level: 'apprentice', title: 'è¦‹ç¿’ã„', description: 'è¦‹ç¿’ã„ãƒ¬ãƒ™ãƒ«ã€‚ã“ã‚Œã‹ã‚‰é ‘å¼µã‚Šã¾ã—ã‚‡ã†ï¼åŸºç¤ã‹ã‚‰å­¦ã³ç›´ã™ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚', color: '#FFA500', emblem: 'ğŸ“š' },
            { threshold: 0, level: 'newbie', title: 'ã«ã‚ã‹', description: 'ã¾ã ã¾ã ã“ã‚Œã‹ã‚‰ï¼ã‚‚ã£ã¨ã‚¢ãƒ‹ãƒ¡ãƒ»æ¼«ç”»ã®ä¸–ç•Œã«è§¦ã‚Œã¦çŸ¥è­˜ã‚’æ·±ã‚ã¾ã—ã‚‡ã†ã€‚', color: '#DC143C', emblem: 'ğŸŒ±' }
        ];

        // æœ€é©åŒ–ã•ã‚ŒãŸCSVè§£æï¼ˆå¿…è¦ãªè¡Œã®ã¿å‡¦ç†ï¼‰
        function parseCSVOptimized(csvText, targetDifficulty = null, maxQuestions = 50) {
            const lines = csvText.split('\n');
            const questions = [];
            let processedCount = 0;
            
            // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¦é–‹å§‹
            for (let i = 1; i < lines.length && questions.length < maxQuestions; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                const columns = line.split(',');
                if (columns.length >= 12) {
                    const difficulty = parseInt(columns[11]);
                    
                    // é›£æ˜“åº¦ãƒ•ã‚£ãƒ«ã‚¿ï¼ˆæŒ‡å®šãŒã‚ã‚Œã°ï¼‰
                    if (targetDifficulty && difficulty !== targetDifficulty) {
                        continue;
                    }
                    
                    questions.push({
                        id: columns[3],
                        category: columns[0],
                        series: columns[1],
                        subcategory: columns[2],
                        text: columns[4],
                        choices: [columns[5], columns[6], columns[7], columns[8]],
                        correct: parseInt(columns[9]) - 1, // CSV is 1-indexed
                        explanation: columns[10],
                        difficulty: difficulty
                    });
                }
                processedCount++;
            }
            
            console.log(`Processed ${processedCount} lines, found ${questions.length} matching questions`);
            return questions;
        }

        // ã‚ªãƒ³ãƒ‡ãƒãƒ³ãƒ‰ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        async function loadQuestionsOnDemand(series, difficulty, count = 10) {
            const filePaths = {
                'ãƒ¯ãƒ³ãƒ”ãƒ¼ã‚¹': 'specifications/data/quiz/ãƒ¯ãƒ³ãƒ”ãƒ¼ã‚¹.csv',
                'åƒ•ã®ãƒ’ãƒ¼ãƒ­ãƒ¼ã‚¢ã‚«ãƒ‡ãƒŸã‚¢': 'specifications/data/quiz/åƒ•ã®ãƒ’ãƒ¼ãƒ­ãƒ¼ã‚¢ã‚«ãƒ‡ãƒŸã‚¢.csv',
                'HUNTERÃ—HUNTER': 'specifications/data/quiz/HUNTERÃ—HUNTER.csv'
            };

            let allQuestions = [];
            loadedQuestionCount = 0;

            try {
                if (series === 'random') {
                    // å„ã‚·ãƒªãƒ¼ã‚ºã‹ã‚‰å°‘ã—ãšã¤èª­ã¿è¾¼ã¿
                    document.getElementById('loading-details').textContent = 'å…¨ã‚·ãƒªãƒ¼ã‚ºã‹ã‚‰å•é¡Œã‚’å–å¾—ä¸­...';
                    
                    for (const [seriesName, filePath] of Object.entries(filePaths)) {
                        document.getElementById('loading-details').textContent = `${seriesName}ã‹ã‚‰å•é¡Œã‚’å–å¾—ä¸­...`;
                        
                        const response = await fetch(filePath);
                        const csvText = await response.text();
                        const targetDiff = difficulty === 'all' ? null : parseInt(difficulty);
                        const questions = parseCSVOptimized(csvText, targetDiff, Math.ceil(count / 3));
                        
                        allQuestions.push(...questions);
                        loadedQuestionCount += questions.length;
                    }
                } else {
                    // ç‰¹å®šã‚·ãƒªãƒ¼ã‚ºã®ã¿èª­ã¿è¾¼ã¿
                    document.getElementById('loading-details').textContent = `${series}ã®å•é¡Œã‚’å–å¾—ä¸­...`;
                    
                    const response = await fetch(filePaths[series]);
                    const csvText = await response.text();
                    const targetDiff = difficulty === 'all' ? null : parseInt(difficulty);
                    const questions = parseCSVOptimized(csvText, targetDiff, count * 2);
                    
                    allQuestions = questions;
                    loadedQuestionCount = questions.length;
                }

                // å¿…è¦ãªæ•°ã ã‘ãƒ©ãƒ³ãƒ€ãƒ é¸æŠ
                const selectedQuestions = shuffleArray(allQuestions).slice(0, count);
                
                document.getElementById('loading-details').textContent = `${selectedQuestions.length}å•ã‚’é¸å‡ºå®Œäº†ï¼`;
                
                return selectedQuestions;
            } catch (error) {
                console.error('Failed to load questions:', error);
                return [];
            }
        }

        // ç”»é¢è¡¨ç¤ºåˆ¶å¾¡
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.add('hidden');
            });
            document.getElementById(screenId).classList.remove('hidden');
        }

        function showMenu() {
            showScreen('menu');
            resetGame();
        }

        function resetGame() {
            currentQuestions = [];
            currentQuestionIndex = 0;
            answers = [];
            selectedAnswer = null;
            loadedQuestionCount = 0;
        }

        // é›£æ˜“åº¦é¸æŠ
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('difficulty-button')) {
                document.querySelectorAll('.difficulty-button').forEach(btn => {
                    btn.classList.remove('selected');
                });
                e.target.classList.add('selected');
                selectedDifficulty = e.target.dataset.difficulty;
            }
        });

        // ã‚¯ã‚¤ã‚ºé–‹å§‹ï¼ˆæœ€é©åŒ–ç‰ˆï¼‰
        async function startQuiz(series) {
            showScreen('loading');
            document.getElementById('loading-text').textContent = 'æœ€é©åŒ–èª­ã¿è¾¼ã¿å®Ÿè¡Œä¸­...';
            
            try {
                // å¿…è¦ãªå•é¡Œã®ã¿ã‚ªãƒ³ãƒ‡ãƒãƒ³ãƒ‰èª­ã¿è¾¼ã¿
                const questions = await loadQuestionsOnDemand(series, selectedDifficulty, 10);
                
                if (questions.length === 0) {
                    alert('é¸æŠã—ãŸæ¡ä»¶ã«è©²å½“ã™ã‚‹å•é¡ŒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚');
                    showMenu();
                    return;
                }

                currentQuestions = questions;
                currentQuestionIndex = 0;
                answers = [];
                
                setTimeout(() => {
                    showScreen('quiz');
                    displayQuestion();
                }, 500);
                
            } catch (error) {
                console.error('Failed to start quiz:', error);
                alert('å•é¡Œã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                showMenu();
            }
        }

        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];  
            }
            return shuffled;
        }

        function displayQuestion() {
            const question = currentQuestions[currentQuestionIndex];
            const difficultyStars = 'â­'.repeat(question.difficulty);
            
            document.getElementById('quiz-title').textContent = `ğŸ¯ ${question.series}ã‚¯ã‚¤ã‚º`;
            document.getElementById('progress').textContent = `å•é¡Œ ${currentQuestionIndex + 1} / ${currentQuestions.length}`;
            document.getElementById('question-meta').textContent = `${question.series} - ${question.subcategory} - é›£æ˜“åº¦: ${difficultyStars}`;
            document.getElementById('question-text').textContent = question.text;
            
            const choicesContainer = document.getElementById('choices');
            choicesContainer.innerHTML = '';
            
            question.choices.forEach((choice, index) => {
                const button = document.createElement('button');
                button.className = 'choice';
                button.textContent = `${index + 1}. ${choice}`;
                button.onclick = () => selectAnswer(index);
                choicesContainer.appendChild(button);
            });
            
            selectedAnswer = null;
            updateNextButton();
        }

        function selectAnswer(answerIndex) {
            selectedAnswer = answerIndex;
            
            document.querySelectorAll('.choice').forEach((choice, index) => {
                choice.classList.toggle('selected', index === answerIndex);
            });
            
            updateNextButton();
        }

        function updateNextButton() {
            const nextButton = document.getElementById('next-button');
            if (selectedAnswer !== null) {
                nextButton.classList.remove('disabled');
                nextButton.textContent = currentQuestionIndex < currentQuestions.length - 1 ? 'æ¬¡ã®å•é¡Œ' : 'çµæœã‚’è¦‹ã‚‹';
            } else {
                nextButton.classList.add('disabled');
            }
        }

        function nextQuestion() {
            if (selectedAnswer === null) return;
            
            const question = currentQuestions[currentQuestionIndex];
            const isCorrect = selectedAnswer === question.correct;
            
            answers.push({
                questionId: question.id,
                selectedAnswer: selectedAnswer,
                isCorrect: isCorrect,
                difficulty: question.difficulty
            });
            
            if (currentQuestionIndex < currentQuestions.length - 1) {
                currentQuestionIndex++;
                displayQuestion();
            } else {
                showResults();
            }
        }

        function showResults() {
            const correctCount = answers.filter(a => a.isCorrect).length;
            const totalCount = answers.length;
            const accuracy = Math.round((correctCount / totalCount) * 100);
            
            // å¹³å‡é›£æ˜“åº¦è¨ˆç®—
            const avgDifficulty = answers.reduce((sum, a) => sum + a.difficulty, 0) / answers.length;
            const avgDifficultyStars = 'â­'.repeat(Math.round(avgDifficulty));
            
            // ã‚ªã‚¿ã‚¯åº¦è¨ˆç®—ï¼ˆé›£æ˜“åº¦ã‚‚è€ƒæ…®ï¼‰
            const otakuLevel = calculateOtakuLevel(accuracy, avgDifficulty);
            
            document.getElementById('emblem').textContent = otakuLevel.emblem;
            document.getElementById('emblem').style.backgroundColor = otakuLevel.color;
            document.getElementById('level-title').textContent = otakuLevel.title;
            document.getElementById('level-title').style.color = otakuLevel.color;
            document.getElementById('level-description').textContent = otakuLevel.description;
            document.getElementById('accuracy').textContent = `${accuracy}%`;
            document.getElementById('score').textContent = `${correctCount}/${totalCount}`;
            document.getElementById('avg-difficulty').textContent = avgDifficultyStars;
            document.getElementById('loaded-count').textContent = `${loadedQuestionCount}å•ï¼ˆæœ€é©åŒ–æ¸ˆã¿ï¼‰`;
            
            showScreen('results');
        }

        function calculateOtakuLevel(accuracy, avgDifficulty) {
            // é›£æ˜“åº¦ãƒœãƒ¼ãƒŠã‚¹ã‚’åŠ ç®—
            const bonusScore = accuracy + (avgDifficulty * 5);
            
            for (let level of otakuLevels) {
                if (bonusScore >= level.threshold) {
                    return level;
                }
            }
            return otakuLevels[otakuLevels.length - 1];
        }

        // åˆæœŸåŒ–
        showScreen('menu');
    </script>
</body>
</html>